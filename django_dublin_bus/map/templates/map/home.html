<!DOCTYPE html>
<html lang="en">

<head>
    {#        Live Geolocation API Connection#}
    <script src="https://cdn.pubnub.com/sdk/javascript/pubnub.4.19.0.min.js"></script>

    {% load staticfiles %}
    <link rel="stylesheet" type="text/css" href="{% static "map/navbar.css" %}">
    <link rel="stylesheet" type="text/css" href="{% static "map/page.css" %}">

    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <title>Dublin Bus - Map</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta charset="utf-8">

</head>

<body>

<script>
    function openNav() {
        document.getElementById("mySidebar").style.width = "450px";
    }

    function closeNav() {
        document.getElementById("mySidebar").style.width = "0";
    }
</script>
    <nav >
        <form action="Getinput" method="get">
            Origin: <input  type="text" name="input_route_origin" id="input_route_origin">
            Destination: <input type="text" name="input_route_destination" id="input_route_destination">
            <input type="button" id="route_submit" value="Search"></input>
        </form>
        <form action="Getinput" method="get">
            Key <input type="text" name="set_home" id="set_home">
            Location: <input type="text" name="set destination" id="set destination">
            <input type="button" id="sethomeandwork" value="Set home and work"></input>
        </form>

    </nav>

    <div class="page_container">
        <div id="mySidebar" class="sidebar">
        <a href="#">
            <div id="right-panel">
                <table id="route_options_container"></table>
            </div>
        </a>
    </div>

    <div id="map"></div>


    <script>
        var model_url = '{% url "run_model" %}';

        var user_marker_image = ""; // Not doing anything yet but to be used for customer user location marker
        var bus_marker_image = ""; // Not doing anything yet but to be used for busstop location marker
        var geo_for_emptystring=new Array;

        {# centering the the initial map position on dublin#}
        window.lat = 53.3498;
        window.lng = -6.2603;

        function getnearby(pos) {
            console.log(pos);
            var service = new google.maps.places.PlacesService(map);
            service.nearbySearch({
                location: pos,
                radius: 500,
                types: ['bus_station']

            }, callback);
        }



        function callback(results, status) {
            if (status === google.maps.places.PlacesServiceStatus.OK) {
                for (var i = 0; i < results.length; i++) {
                    var placeId = results[i].place_id;
                    var geocoder = new google.maps.Geocoder;
                    geocoder.geocode({'placeId': placeId}, function (results, status) {
                        if (status === 'OK') {
                            if (results[0]) {
                                console.log("Lat: "+results[0].geometry.location.lat() + " " + " Lon: "+results[0].geometry.location.lng());
                            }
                        }

                    });
                }
            }
        }

        {#Test to see if the browser has HTML5 geolocation#}
        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(updatePosition);
            }
            return null;
        }

        {#Updates the map position values to users location#}
        function updatePosition(position) {
            if (position) {
                pos={
                    lat:position.coords.latitude,
                    lng:position.coords.longitude
                }
                window.lat = position.coords.latitude;
                window.lng = position.coords.longitude;
                geo_for_emptystring.length = 0
                geo_for_emptystring.push(position.coords.longitude);
                geo_for_emptystring.push(position.coords.latitude);
                getnearby(pos);
            }
        }

        {#interval in ms#}
        setInterval(function () {
            updatePosition(getLocation());
        }, 10000);

        function currentLocation() {
            return {lat: window.lat, lng: window.lng};
        }

        var map; // for initialising the maps map object
        var geocoder; // for initialising the maps geocoder object
        var user_location_marker;
        var markers = []; // storing the markers as we create them
        var origin_searchbox;
        var destination_searchbox;
        var directionsRenderer;
        var text_display=new Array;
        var hometowork=new Array;
        var origin;
        var dest;
        var dest_work;
        var origin_work;

        var initialize = function () {
            map = new google.maps.Map(document.getElementById('map'), {
                center: {lat: lat, lng: lng}, //investigate where lat nd lng variables are coming from
                zoom: 12,

            });

            // look at changing where this is positioned in script to resolve marker jumping from O'connell street
            user_location_marker = new google.maps.Marker({position: {lat: lat, lng: lng}, map: map});


            window.initialize = initialize;
            var toggle = true;
            var redraw = function (payload) {
                lat = payload.message.lat;
                lng = payload.message.lng;

                user_location_marker.setPosition({lat: lat, lng: lng, alt: 0});
                if (toggle) {
                    map.setCenter({lat: lat, lng: lng, alt: 0});
                    map.setZoom(16);
                    toggle = false;
                }
            };

            var pnChannel = "map2-channel";

            var pubnub = new PubNub({
                publishKey: 'pub-c-180f8ae2-5a29-43b3-88a3-c550c9d1352c',
                subscribeKey: 'sub-c-165dd5b0-9d91-11e9-b7bc-46e9b2e3ba6e'
            });

            pubnub.subscribe({channels: [pnChannel]});
            pubnub.addListener({message: redraw});

            setInterval(function () {
                pubnub.publish({channel: pnChannel, message: currentLocation()});
            }, 5000);

            geocoder = new google.maps.Geocoder();


            origin_searchbox = document.getElementById('input_route_origin');
            destination_searchbox = document.getElementById('input_route_destination');
            sethome = document.getElementById('set_home');
            destination = document.getElementById('set destination');
            var options = {
                types: ['geocode'],
                componentRestrictions: {country: 'ie'}
            };

            autocomplete = new google.maps.places.Autocomplete(origin_searchbox, options);
            autocomplete = new google.maps.places.Autocomplete(destination_searchbox, options);
            autocomplete = new google.maps.places.Autocomplete(destination, options);


        };

        /* Action after pressing the submit button. */
        document.getElementById('route_submit').addEventListener('click', function () {
            geocodeAddress();
        });

        document.getElementById('sethomeandwork').addEventListener('click', function () {
<<<<<<< HEAD
            window.localStorage.setItem(sethome.value,destination.value);
=======
            window.localStorage.setItem('home', sethome.value);
            window.localStorage.setItem('work',destination.value);
>>>>>>> Feature_implementation

        });

        /* Function that performs geodecoding. */
        function geocodeAddress() {
<<<<<<< HEAD
            var origin_new = "";
            var dest_new = "";
            if (origin_searchbox.value == "") {
                if (Object.keys(window.localStorage).includes(destination_searchbox.value)) {
                    console.log("here also");
                    dest_new = window.localStorage.getItem(destination_searchbox.value);
                } else {
                    dest_new = destination_searchbox.value
                }
                geocoder.geocode({'address': dest_new}, function (res_dest, status) {
                    if (status === 'OK') {
                        console.log(status);
                        mapLocation(
                            geo_for_emptystring[1],
                            geo_for_emptystring[0],
                            res_dest[0].geometry.location.lat(),

                            res_dest[0].geometry.location.lng()
                        );
                        console.log("success")
                        console.log(geo_for_emptystring);
                    }
                });
            } else {
                if (Object.keys(window.localStorage).includes(origin_searchbox.value)) {
                    origin_new = window.localStorage.getItem(origin_searchbox.value);
                } else {
                    origin_new = origin_searchbox.value
                }

                if (Object.keys(window.localStorage).includes(destination_searchbox.value)) {
                    console.log("here also");
                    dest_new = window.localStorage.getItem(destination_searchbox.value);
                } else {
                    dest_new = destination_searchbox.value
                }

                console.log(origin_new);
                console.log(dest_new);
=======
            var origin_new="";
            var dest_new="";


            if(origin_searchbox.value.toLowerCase() == "home" || origin_searchbox.value.toLowerCase() == "work"){
                origin_new=window.localStorage.getItem(origin_searchbox.value.toLowerCase());
            }
            else{
                origin_new=origin_searchbox.value
            }

            if(destination_searchbox.value.toLowerCase() == "home" || destination_searchbox.value.toLowerCase() == "work"){
                dest_new=window.localStorage.getItem(destination_searchbox.value.toLowerCase());
            }
            else{
                dest_new=destination_searchbox.value
            }

            console.log(origin_new);
            console.log(dest_new);
>>>>>>> Feature_implementation
                geocoder.geocode({'address': origin_new},
                    function (res_origin, status) {
                        /* If place is legitimate and able to get GPS co-ordinates. */
                        if (status === 'OK') {
                            /* Set center based upon the lat and longitiude on final map */
                            map.setCenter(res_origin[0].geometry.location);

                            /* Status of response is used for checking if
                        the respose from geocoding is valid or not (N.B. This is not a formal definition). */
                            geocoder.geocode({'address': dest_new}, function (res_dest, status) {

                                if (status === 'OK') {
                                    mapLocation(
                                        res_origin[0].geometry.location.lat(),
                                        res_origin[0].geometry.location.lng(),
                                        res_dest[0].geometry.location.lat(),
                                        res_dest[0].geometry.location.lng()
                                    );
                                } else {
                                    alert('Geocode was not successful for the following reason: ' + status);
                                }

                            });

                        } else {
                            alert('Geocode was not successful for the following reason: ' + status);

                        }

                    }
                );
            }
        }


            /* Displaying the actual route on map */
            function mapLocation(origin_lat, origin_lng, dest_lat, dest_lng) {
                var origin = new google.maps.LatLng(origin_lat, origin_lng);
                var destination = new google.maps.LatLng(dest_lat, dest_lng);


                if (directionsRenderer) {
                    directionsRenderer.setMap(null);
                }
                var directionsService = new google.maps.DirectionsService();

                directionsRenderer = new google.maps.DirectionsRenderer();

                directionsRenderer.setMap(map);
                calculateAndDisplayRoute(directionsService, directionsRenderer);

                function calculateAndDisplayRoute(directionsService, directionsRenderer) {
                    directionsService.route({
                        origin: origin,
                        destination: destination,
                        travelMode: 'TRANSIT',
                        provideRouteAlternatives: true,
                        transitOptions: {
                            modes: ['BUS'],
                            routingPreference: 'FEWER_TRANSFERS'
                        },
                        unitSystem: google.maps.UnitSystem.IMPERIAL
                    }, function (response, status) {
                        if (status === 'OK') {
                            console.log(response);
                            directionsRenderer.setDirections(response);
                            var route_name=[];
                            var text="";
                            console.log(response.routes.length);
                            let route_options_table = document.getElementById('route_options_container');
                            route_options_table.innerHTML = "";
                            var model_journeys = [];
                            for (i = 0; i < response.routes.length; i++) {
                                console.log("Journey Number: " + i);
                                let journey = {};
                                let new_route_row = route_options_table.insertRow(-1);
                                new_route_row.id = i;

                                let steps_counter = 0;
                                let steps_len = response.routes[i].legs[0].steps.length;
                                for (let step of response.routes[i].legs[0].steps) {
                                    let newCell = new_route_row.insertCell(-1);
                                    if (step.travel_mode == "WALKING") {
                                        newCell.innerHTML = '<i class="material-icons" style="font-size:30px;color:white">directions_walk</i>';
                                    } else if (step.travel_mode == "TRANSIT") {
                                        let route_dict = {
                                            "Origin_Lat": step.transit.departure_stop.location.lat(),
                                            "Origin_Lon": step.transit.departure_stop.location.lng(),
                                            "Dest_Lat": step.transit.arrival_stop.location.lat(),
                                            "Dest_Lon": step.transit.arrival_stop.location.lng(),
                                            "Origin": step.transit.arrival_stop.name,
                                            "Destination": step.transit.headsign,
                                            "Departure_Datetime": new Date(step.transit.departure_time.value)
                                        };
                                        journey[step.transit.line.short_name] = route_dict;
                                        console.log();
                                        text+="Origin_Lat: " + step.transit.departure_stop.location.lat()+"\nOrigin_Lon: " + step.transit.departure_stop.location.lng();
                                        route_name[i]=text;
                                        newCell.innerHTML = '<i class="material-icons" style="font-size:30px;color:white">directions_bus</i>';
                                        let newCell2 = new_route_row.insertCell(-1);
                                        let current_route = step.transit.line.short_name;
                                        newCell2.innerHTML = '<p>' + current_route + '</p>';
                                    }
                                    if (steps_counter < steps_len - 1) {
                                        let nextStepCell = new_route_row.insertCell(-1);
                                        nextStepCell.innerHTML = '<i class="material-icons" style="font-size:30px;color:white">navigate_next</i>';
                                    }
                                    steps_counter += 1;


                                }


                                model_journeys.push(journey);
                                console.log("****************");

                                new_route_row.onclick = function () {
                                    console.log(this.id);
                                    directionsRenderer.setRouteIndex(parseInt(this.id));
                                    console.log(journey);
                                    for (let value of Object.keys(journey)) {
                                        console.log(journey[value]); // John, then 30
                                    }



                                };

                            }
                            console.log(model_journeys);
                            Ajax_Model(model_journeys);
                        } else {
                            window.alert('Directions request failed due to ' + status);
                        }
                    });

                }
            }







    </script>

    <script>
        function AjaxGetRoutes(stop_id, infowindow, stop_name) {
            console.log(stop_id);
            $.ajax({
                type: "POST",
                data: {'stop_id': stop_id},
                url: '{% url "get_routes" %}',

                success: function (routes, status) {
                    {#Do unit test to make sure the right format is being returned and the data is correct#}
                    console.log(routes);
                    console.log(status);

                    {#Refactor content string to stop_info_content or something like this#}
                    var stop_info_content = '<div id="stop_name">' + stop_name + '</div>';
                    stop_info_content += '<div><ul>';
                    var route_list = []

                    {#Record performance for this loop execution, see is there a better way to do it#}
                    console.time('Time');
                    //var start = new Date().getTime();
                    for (route in routes) {
                        var route_number = routes[route].fields.bus_numbers; //remember route is a string, not a number "0", "1", etc.
                        if (!route_list.includes(route_number)) {
                            stop_info_content += '<li>' + route_number + '</li>';
                            route_list.push(route_number);
                        }
                    }
                    console.timeEnd('Time');
                    //var end = new Date().getTime();
                    //var time = end - start;
                    //console.log('Execution time: ' + time);

                    stop_info_content += '</ul></div>';

                    infowindow.setContent(stop_info_content);
                },
                error: function (jqXHR) {
                    console.log(jqXHR);
                    {#    Might be worth displaying this to the user in meaningful way #}
                }
            });
        }
    </script>
</div>

{% load staticfiles %}
<script src="{% static "map/js/ajax_model.js" %}"></script>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script src="https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/markerclusterer.js"></script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDCdOS87zrKfHICHXYGsrcQA8WX9gG3o1I&callback=initialize&libraries=places"></script>
</body>
</html>