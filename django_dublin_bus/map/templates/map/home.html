<!DOCTYPE html>
<html class="no-js" lang="en" dir="ltr">
<head>
    <title>Dublin Bus - Map</title>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    {#        Live Geolocation API Connection#}

    <!--Jquery-->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    <!--For csrf token-->
    <script src="https://cdn.jsdelivr.net/npm/js-cookie@2/src/js.cookie.min.js"></script>

    {% load staticfiles %}
    <link rel="stylesheet" type="text/css" href="{% static 'map/css/home.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'map/css/mobile_bottom_nav_bar.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'map/css/map.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'map/css/info_section.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'map/css/directions_view.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'map/css/stop_info_view.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'map/css/route_options.css' %}">
    <link rel="shortcut icon" type="image/png" href="{% static 'map/images/favicon.ico' %}">


    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <!-- Compressed CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/foundation-sites@6.5.3/dist/css/foundation.min.css" integrity="sha256-xpOKVlYXzQ3P03j397+jWFZLMBXLES3IiryeClgU5og= sha384-gP4DhqyoT9b1vaikoHi9XQ8If7UNLO73JFOOlQV1RATrA7D0O7TjJZifac6NwPps sha512-AKwIib1E+xDeXe0tCgbc9uSvPwVYl6Awj7xl0FoaPFostZHOuDQ1abnDNCYtxL/HWEnVOMrFyf91TDgLPi9pNg==" crossorigin="anonymous">
    <!-- Compressed JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/foundation-sites@6.5.3/dist/js/foundation.min.js" integrity="sha256-/PFxCnsMh+nTuM0k3VJCRch1gwnCfKjaP8rJNq5SoBg= sha384-9ksAFjQjZnpqt6VtpjMjlp2S0qrGbcwF/rvrLUg2vciMhwc1UJJeAAOLuJ96w+Nj sha512-UMSn6RHqqJeJcIfV1eS2tPKCjzaHkU/KqgAnQ7Nzn0mLicFxaVhm9vq7zG5+0LALt15j1ljlg8Fp9PT1VGNmDw==" crossorigin="anonymous"></script>
</head>

<body>
    <div id="page_layout" class="grid-y grid-frame">
        <div id="map_container" class="cell">
            <div id="map"></div>
        </div>

        <div id="info_section" class="cell grid-x">
            <div id="directions_view_section" class="cell align-self-middle" style="display:none"></div>
            <div id="journey_results_view_section" style="display:none"></div>
            <div id="favourites_view_section" class="cell grid-x align-self-middle" style="display:none"></div>
            <div id="stop_info_view_section" class="cell grid-y grid-frame" style="display:none"></div>
        </div>

        <div id="bottom_navbar" class="cell">
            <div class="mobile-app-icon-bar">
                {% load staticfiles %}
                <a id='directions_view_button' class="footer-link" onclick="populate_info('directions_view')"><img class="fa" aria-hidden="true" src="{% static "map/images/directions.png" %}"></a>
                <a id="favourites_view_button" class="footer-link" onclick="populate_info('favourites_view')"><img class="fa" aria-hidden="true" src="{% static "map/images/favourites.png" %}"></a>
                <a id='stop_info_view_button' class="footer-link" onclick="populate_info('stop_info_view')"><img class="fa" aria-hidden="true" src="{% static "map/images/journey.png" %}"></a>
            </div>
        </div>
    </div>

    <!--Imporing This script gives us access to the csrf token returned by django-->
    {% csrf_token %}
    <script type="text/javascript">var csrftoken = jQuery("[name=csrfmiddlewaretoken]").val();</script>

    <script>
        <!--Global Variables-->

        //These urls are used in the ajax queries to link to the django urls
        // (We do this as we can't use django code within external js files)
        var model_url = '{% url "run_model" %}';
        var get_sun_url = '{% url "get_sun" %}';
        var get_routes_url = '{% url "get_routes" %}';

        //This will contain the lat lng of the users current position to be passed if they don't enter an origin
        // ( This duplicating variables already created so should be refactored and removed)

        var back_button_image_url = "{% static 'map/images/back_button.png' %}";
        var user_marker_image_url = "{% static 'map/images/user_location_marker.png' %}"; // Not doing anything yet but to be used for customer user location marker
        var bus_marker_image_url = "{% static 'map/images/bus_stop_marker.png' %}"; // Not doing anything yet but to be used for busstop location marker

        var map; // for initialising the maps map object
        var geocoder; // for initialising the maps geocoder object

        var nearby_radius;
        var markers = []; // storing the markers as we create them

        var autocomplete_options;
        var marker_bounds;
        var origin_searchbox;
        var destination_searchbox;
        var directionsRenderer;

        var rendered_route_list = [];

        var sunrise;
        var sunset;

        var stop_data_list_string = "";

        var geolocationFlag = true;
        var userPosition;
        var bounds;

    </script>

    {% load staticfiles %}
    <script type="text/javascript" src="{% static 'map/js/csrf_ajax_token_setting.js' %}"></script>
    <script type="text/javascript" src="{% static 'map/js/journey_date_selector.js' %}"></script>
    <script type="text/javascript" src="{% static 'map/js/geolocation.js' %}"></script>
    <script type="text/javascript" src="{% static 'map/js/cache_user_favourites.js' %}"></script>
    <script type="text/javascript" src="{% static 'map/js/set_map_night_mode.js' %}"></script>
    <script type="text/javascript" src="{% static 'map/js/get_nearby_markers.js' %}"></script>
    <script type="text/javascript" src="{% static 'map/js/map_initialiser.js' %}"></script>
    <script type="text/javascript" src="{% static 'map/js/haversine.js' %}"></script>

    <script>
        function loopBusStops(){
            console.log("Calling loopBusStops function!");

            var bus_marker_icon = {
                url: bus_marker_image_url, //the image itself
                scaledSize: new google.maps.Size(50, 50) // resizing image to 50% smaller
            };

            {% for bus_stop in bus_stops %}

                var latLng = {lat:{{ bus_stop.stop_lat}}, lng:{{bus_stop.stop_lng }}};
                var stop_info = {"stop_id":'{{bus_stop.stop_id}}', "actual_stop_id":'{{bus_stop.actual_stop_id}}', "stop_name":'{{bus_stop.stop_name}}'};

                var marker = new google.maps.Marker({
                    position: latLng,
                    icon: bus_marker_icon,
                    stop_info: stop_info
                });

                google.maps.event.addListener(marker, 'click', function () {
                    populate_info('stop_info_view')
                    search_stop_number(this.stop_info.actual_stop_id);
                });

                markers.push(marker);
                stop_data_list_string += `<option value="${'{{bus_stop.actual_stop_id}}'}">${'{{bus_stop.stop_name}}'} (${'{{bus_stop.actual_stop_id}}'})</option>`;
            {% endfor %}
        }
    </script>


    <script type="text/javascript" src="{% static 'map/js/generateRoute.js' %}"></script>
    <script type="text/javascript" src="{% static 'map/js/map_routing.js' %}"></script>
    <script type="text/javascript" src="{% static 'map/js/clearSearch.js' %}"></script>
    <script type="text/javascript" src="{% static 'map/js/populate_info_section.js' %}"></script>
    <script type="text/javascript" src="{% static 'map/js/geocode_address.js' %}"></script>
    <script type="text/javascript" src="{% static 'map/js/directions_view.js' %}"></script>
    <script type="text/javascript" src="{% static 'map/js/journey_results_view.js' %}"></script>
    <script type="text/javascript" src="{% static 'map/js/favourites_view.js' %}"></script>
    <script type="text/javascript" src="{% static 'map/js/stop_info_view.js' %}"></script>
    <script type="text/javascript" src="{% static 'map/js/ajax_model.js' %}"></script>
    <script type="text/javascript" src="{% static 'map/js/ajax_get_routes.js' %}"></script>


    <script src="https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/markerclusterer.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD3jfCg18B1ksPENyBJTzmkM78Uva1XiKw&callback=initialize&libraries=places,geometry"></script>
    <script>
        populate_info("directions_view");
    </script>
    <script>$(document).foundation();</script>


</body>
</html>